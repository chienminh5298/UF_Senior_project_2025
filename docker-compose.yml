version: '3.8'

services:
    ufdatabase:
        image: mysql
        environment:
            MYSQL_ROOT_PASSWORD: moneymachine
            MYSQL_DATABASE: moneymachine
        volumes:
            - ./backupDB:/docker-entrypoint-initdb.d
            - db-volume:/var/lib/mysql
        healthcheck:
            test: ['CMD', 'mysqladmin', 'ping', '-h', 'localhost']
            timeout: 5s
            retries: 3
        restart: always
        container_name: ufdatabase

    bottrade:
        image: 'chienminh5298/uf-bottrade:production'
        # build:
        #     context: ./botTrade
        #     dockerfile: Dockerfile    #Use build for test production env on local pc, use image for production env on EC2
        depends_on:
            ufdatabase:
                condition: service_healthy
        env_file: ./botTrade/.env
        volumes:
            - log-volume:/app/log
        container_name: bottrade
        restart: always

    backend:
        image: 'chienminh5298/uf-backend:production'
        # build:
        #     context: ./moneyMachine
        #     dockerfile: Dockerfile
        depends_on:
            ufdatabase:
                condition: service_healthy
        ports:
            - '1234:1234'
            - '7777:7777'
        env_file: ./moneyMachine/.env
        volumes:
            - log-volume:/app/log
            - ./certbot/conf:/etc/letsencrypt
        container_name: backend
        restart: always

    frontend-admin:
        image: 'chienminh5298/uf-frontend-admin:production'
        # build:
        #     context: ./moneyMachine-FE-admin
        #     dockerfile: Dockerfile
        depends_on:
            - backend
        container_name: frontend-admin
        restart: always

    frontend-user:
        image: 'chienminh5298/uf-frontend-user:production'
        # build:
        #     context: ./moneyMachine-FE
        #     dockerfile: Dockerfile
        depends_on:
            - backend
        container_name: frontend-user
        restart: always

    # This container help nginx can run 2 difference FE webserver on same port depend on sub-domain
    nginx-proxy:
        image: nginx
        ports:
            - '80:80'
            - '443:443'
        volumes:
            - ./nginx.conf:/etc/nginx/nginx.conf
            - ./certbot/conf:/etc/letsencrypt
        depends_on:
            - backend
            - frontend-admin
            - frontend-user
        container_name: nginx
    certbot:
        image: certbot/dns-cloudflare
        container_name: certbot
        volumes: 
            - ./certbot/conf:/etc/letsencrypt
            - ./certbot/www:/var/www/certbot
            - ./certbot/cloudflare.ini:/root/cloudflare.ini:ro
        command: >-
            certonly --dns-cloudflare
            --dns-cloudflare-credentials /root/cloudflare.ini
            --dns-cloudflare-propagation-seconds 15
            --email chienminh5298@gmail.com
            --agree-tos --no-eff-email
            --force-renewal
            -d moneymachine.work
            -d *.moneymachine.work
        restart: on-failure

volumes:
    db-volume:
    log-volume: